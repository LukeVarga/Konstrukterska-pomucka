<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Příručka pro konstruktéry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .component-btn {
            transition: all 0.3s ease;
        }
        .component-btn.active {
            background-color: #1d4ed8; /* blue-700 */
            color: white;
            box-shadow: 0 4px 14px 0 rgba(0, 118, 255, 0.39);
        }
        .variation-btn {
            transition: all 0.2s ease;
        }
        .variation-btn.active {
            background-color: #2563eb; /* blue-600 */
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .detail-card {
            transition: all 0.3s ease;
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Interaktivní příručka pro konstruktéry</h1>
            <p class="text-md text-gray-600 mt-2">Vyberte si komponentu pro zobrazení technických detailů.</p>
        </header>

        <div id="error-container" class="w-full max-w-4xl mx-auto"></div>
        <div id="category-selector" class="flex justify-center flex-wrap gap-3 mb-8"></div>
        <div id="component-selector" class="w-full max-w-4xl mx-auto text-center mb-8"></div>

        <div id="component-details" class="w-full max-w-4xl mx-auto">
            <div id="initial-state" class="text-center p-10 bg-white rounded-xl shadow-md">
                <div class="loader mx-auto"></div>
                <h3 class="mt-4 text-sm font-medium text-gray-900">Načítám data...</h3>
                <p class="mt-1 text-sm text-gray-500">Čekejte prosím, data se načítají ze souborů.</p>
            </div>
        </div>
    </div>

    <script>
        // --- Konfigurace ---
        const categories = {
            "Lisovací šrouby": {
                file: "data - Lisovací šrouby.csv",
                icon: "Lisovací šroub ikona.png",
                variationKey: "L±0,4"
            },
            "Lisovací matice": {
                file: "data - Lisovací matice.csv",
                icon: "Lisovací matice ikona.png",
                variationKey: null
            },
            // OPRAVA 1: Aktualizované názvy souborů
            "Lisovací sloupky uzavřené": {
                file: "data - Lisovací sloupky uzavřené.csv",
                icon: "2.png",
                defaultImage: "2.png",
                variationKey: "L"
            },
            // OPRAVA 1: Aktualizované názvy souborů
            "Lisovací sloupky průchozí": {
                file: "data - Lisovací sloupky průchozí.csv",
                icon: "1.png",
                defaultImage: "1.png",
                variationKey: "L"
            }
        };
        const imageBasePath = 'images/';

        // --- Globální proměnné ---
        let componentsData = {};
        let activeCategory = null;
        let activeGroupKey = null;

        const errorContainer = document.getElementById('error-container');
        const categorySelector = document.getElementById('category-selector');
        const componentSelector = document.getElementById('component-selector');
        const componentDetails = document.getElementById('component-details');
        const initialStateDiv = document.getElementById('initial-state');

        async function fetchAndProcessData() {
            const fetchPromises = Object.entries(categories).map(async ([categoryName, categoryData]) => {
                try {
                    const response = await fetch(categoryData.file);
                    if (!response.ok) throw new Error(`nebyl nalezen (stav: ${response.status})`);
                    const csvText = await response.text();
                    parseCsvForCategory(csvText, categoryName);
                    return { status: 'fulfilled', category: categoryName };
                } catch (error) {
                    console.error(`Chyba při načítání souboru pro kategorii '${categoryName}':`, error);
                    return { status: 'rejected', category: categoryName, reason: error.message, file: categoryData.file };
                }
            });

            const results = await Promise.all(fetchPromises);
            const failedLoads = results.filter(r => r.status === 'rejected');

            if (results.every(r => r.status === 'rejected')) {
                 initialStateDiv.innerHTML = `<div class="bg-red-50 border border-red-200 text-red-800 p-4 rounded-lg"><h3 class="text-xl font-bold">Chyba při načítání dat</h3><p class="mt-2">Aplikaci se nepodařilo načíst žádný z datových souborů. Zkontrolujte, zda jsou soubory CSV ve správné složce, mají správné názvy a že spouštíte stránku přes lokální server (např. pomocí 'Live Server' ve VS Code).</p></div>`;
            } else {
                if (failedLoads.length > 0) {
                    const errorMessages = failedLoads.map(f => `<li>Soubor <strong>${f.file}</strong> pro kategorii <strong>${f.category}</strong> ${f.reason}. Zkontrolujte název souboru a jeho obsah.</li>`).join('');
                    errorContainer.innerHTML = `<div class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-700 p-4 mb-4 rounded-md" role="alert">
                        <p class="font-bold">Upozornění</p>
                        <ul class="list-disc list-inside mt-2 text-sm">${errorMessages}</ul>
                    </div>`;
                }
                initializeApp();
            }
        }

        function parseCsvForCategory(csvText, categoryName) {
            if (csvText.charCodeAt(0) === 0xFEFF) {
                csvText = csvText.slice(1);
            }

            const lines = csvText.trim().split(/\r?\n/);
            if (lines.length < 2) return;
            
            const parseCsvRow = (rowText) => {
                const result = [];
                let currentField = '';
                let inQuotes = false;
                for (const char of rowText) {
                    if (char === '"' && (inQuotes || currentField.length === 0)) {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(currentField.trim());
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                result.push(currentField.trim());
                return result.map(field => field.replace(/^"|"$/g, '').trim());
            };

            const headers = parseCsvRow(lines[0]);
            const dataRows = lines.slice(1);
            
            if (!componentsData[categoryName]) componentsData[categoryName] = {};

            const nameIndex = headers.indexOf('Name');
            const imageIndex = headers.indexOf('Image');
            const descriptionIndex = headers.indexOf('Description');
            const idIndex = headers.indexOf('ID');

            if (nameIndex === -1 || imageIndex === -1 || descriptionIndex === -1) {
                console.error(`Chyba ve struktuře souboru pro '${categoryName}'. Chybí jeden z povinných sloupců: 'Name', 'Image', 'Description'.`);
                const errorDiv = document.createElement('div');
                errorDiv.className = "bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 rounded-md";
                errorDiv.innerHTML = `<p class="font-bold">Chyba v datech</p><p>Kategorie <strong>${categoryName}</strong> nemohla být načtena. V souboru chybí povinné sloupce ('Name', 'Image', 'Description').</p>`;
                errorContainer.appendChild(errorDiv);
                return;
            }

            dataRows.forEach((rowText, rowIndex) => {
                if (!rowText) return;
                const row = parseCsvRow(rowText);
                const componentName = row[nameIndex];
                if (!componentName) return;
                
                const uniqueIdentifier = (idIndex !== -1 && row[idIndex]) ? row[idIndex] : `${componentName}-${rowIndex}`;
                const groupKey = categories[categoryName].variationKey ? componentName : uniqueIdentifier;

                if (!componentsData[categoryName][groupKey]) {
                    componentsData[categoryName][groupKey] = {
                        name: componentName,
                        image: row[imageIndex],
                        description: row[descriptionIndex],
                        variations: []
                    };
                }
                
                const id = (idIndex !== -1 && row[idIndex]) ? row[idIndex] : `${categoryName}-${groupKey}-${rowIndex}`;
                const variation = { id: id, params: {} };
                headers.forEach((header, index) => {
                    if (row[index] !== undefined && row[index] !== null) variation.params[header] = row[index];
                });
                componentsData[categoryName][groupKey].variations.push(variation);
            });
        }

        function initializeApp() {
            initialStateDiv.style.display = 'none';
            renderCategoryButtons();
            const firstAvailableCategory = Object.keys(categories).find(cat => componentsData[cat] && Object.keys(componentsData[cat]).length > 0);
            if (firstAvailableCategory) {
                selectCategory(firstAvailableCategory);
            } else {
                 componentDetails.innerHTML = `<div class="text-center p-10 bg-white rounded-xl shadow-md"><h3 class="text-lg font-medium text-gray-900">Žádná data k zobrazení</h3><p class="mt-1 text-sm text-gray-500">Nepodařilo se načíst data pro žádnou kategorii.</p></div>`;
            }
        }

        function showComponentDetails(category, groupKey, selectedVariationId = null) {
            const componentGroup = componentsData[category]?.[groupKey];
            if (!componentGroup) {
                console.error(`Komponenta s klíčem '${groupKey}' v kategorii '${category}' nebyla nalezena.`);
                return;
            }

            activeGroupKey = groupKey;
            const activeVariation = selectedVariationId 
                ? componentGroup.variations.find(v => v.id === selectedVariationId)
                : componentGroup.variations[0];
            
            if (!activeVariation) {
                console.error(`Varianta s ID '${selectedVariationId}' nebyla nalezena.`);
                return;
            }

            const categoryConfig = categories[category];
            const variationKey = categoryConfig.variationKey;
            
            let variationsBlockHtml = '';
            if (variationKey && componentGroup.variations.length > 1) {
                const variationsHtml = componentGroup.variations.map(variation => {
                    let buttonText = variation.params[variationKey] !== undefined ? variation.params[variationKey] : variation.id;
                    
                    // OPRAVA 2: Získání POSLEDNÍHO čísla z textu varianty.
                    // Najde VŠECHNA čísla v textu (díky 'g' na konci)
                    const numberMatches = String(buttonText).match(/\d+(\.\d+)?/g);
                    // Pokud nějaká čísla našel, vezme to POSLEDNÍ z nich
                    if (numberMatches && numberMatches.length > 0) {
                        buttonText = numberMatches[numberMatches.length - 1];
                    }

                    const isActive = variation.id === activeVariation.id;
                    return `<button onclick="showComponentDetails('${category}', '${groupKey}', '${variation.id}')" class="variation-btn px-3 py-1.5 text-sm font-medium rounded-md shadow-sm border ${isActive ? 'active' : 'bg-white text-gray-700 hover:bg-gray-50'}">${buttonText}</button>`;
                }).join('');

                variationsBlockHtml = `
                    <div class="mb-6">
                        <h4 class="text-sm font-bold text-gray-500 mb-2">Dostupné varianty (${variationKey}):</h4>
                        <div class="flex flex-wrap gap-2">${variationsHtml}</div>
                    </div>`;
            }

            const paramsHtml = Object.entries(activeVariation.params).map(([key, value]) => {
                if (['Name', 'Image', 'Description', 'ID'].includes(key) || value === '') return ''; 
                return `<tr class="border-b border-gray-200 last:border-b-0"><td class="py-3 px-4 text-sm font-medium text-gray-600">${key}</td><td class="py-3 px-4 text-sm text-gray-800 font-semibold">${value}</td></tr>`;
            }).join('');

            const imageFile = componentGroup.image || categoryConfig.defaultImage;
            const imageUrl = imageFile ? `${imageBasePath}${imageFile}` : 'https://placehold.co/600x400/e0e0e0/757575?text=Obr%C3%A1zek+nenalezen';
            
            componentDetails.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg overflow-hidden detail-card">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-0">
                        <div class="p-4 bg-gray-50 flex items-center justify-center"><img src="${imageUrl}" alt="Výkres ${componentGroup.name}" class="max-w-full h-auto rounded-lg object-contain" onerror="this.onerror=null;this.src='https://placehold.co/600x400/e0e0e0/757575?text=Obr%C3%A1zek+nenalezen';this.alt='Chyba načtení obrázku';"></div>
                        <div class="p-6">
                            <h2 class="text-2xl font-bold text-blue-700 mb-2">${activeVariation.params.Name || componentGroup.name}</h2>
                            <p class="text-gray-600 mb-4">${componentGroup.description}</p>
                            ${variationsBlockHtml}
                            <div class="overflow-x-auto rounded-lg border border-gray-200">
                                <table class="w-full text-left"><tbody class="bg-white">${paramsHtml}</tbody></table>
                            </div>
                        </div>
                    </div>
                </div>`;
            initialStateDiv.style.display = 'none';
            renderComponentButtons();
            renderCategoryButtons();
        }

        function renderComponentButtons() {
            componentSelector.innerHTML = '';
            if (!activeCategory || !componentsData[activeCategory]) return;
            
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex justify-center flex-wrap gap-2';
            
            buttonContainer.innerHTML = Object.entries(componentsData[activeCategory]).map(([groupKey, group]) => {
                const isActive = groupKey === activeGroupKey;
                return `<button class="component-btn px-4 py-2 text-sm font-medium rounded-md shadow-sm border ${isActive ? 'active' : 'bg-white text-gray-700 hover:bg-gray-50'}" onclick="showComponentDetails('${activeCategory}', '${groupKey}')">${group.name}</button>`;
            }).join('');
            
            componentSelector.appendChild(buttonContainer);
        }
        
        function selectCategory(categoryName) {
            if (activeCategory === categoryName && componentDetails.innerHTML !== '') return;

            activeCategory = categoryName;
            activeGroupKey = null; 
            componentDetails.innerHTML = '';
            initialStateDiv.style.display = 'block';
            initialStateDiv.innerHTML = `<svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z" /></svg><h3 class="mt-2 text-sm font-medium text-gray-900">Vyberte díl</h3><p class="mt-1 text-sm text-gray-500">Nyní si vyberte konkrétní díl z kategorie "${categoryName}".</p>`;
            
            renderCategoryButtons();
            renderComponentButtons(); 
        }

        function renderCategoryButtons() {
            categorySelector.innerHTML = Object.entries(categories).map(([categoryName, config]) => {
                if (!componentsData[categoryName] || Object.keys(componentsData[categoryName]).length === 0) return '';
                const isActive = categoryName === activeCategory;
                
                const iconHtml = config.icon ? `<img src="${imageBasePath}${config.icon}" alt="" class="w-5 h-5 mr-2 inline-block">` : '';

                return `<button class="component-btn px-5 py-2.5 text-base font-semibold rounded-lg shadow-md border flex items-center justify-center ${isActive ? 'active' : 'bg-white text-blue-600 border-blue-600 hover:bg-blue-50'}" onclick="selectCategory('${categoryName}')">
                            ${iconHtml}
                            <span>${categoryName}</span>
                        </button>`;
            }).join('');
        }

        window.onload = fetchAndProcessData;
    </script>
</body>
</html>
